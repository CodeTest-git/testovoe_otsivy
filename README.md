# Yandex Maps Insights

Веб-приложение для сбора и отображения отзывов, рейтинга и фотографий организаций из Яндекс Карт.

![Laravel](https://img.shields.io/badge/Laravel-12-FF2D20?logo=laravel&logoColor=white)
![Vue.js](https://img.shields.io/badge/Vue.js-3-4FC08D?logo=vuedotjs&logoColor=white)
![Tailwind CSS](https://img.shields.io/badge/Tailwind_CSS-4-06B6D4?logo=tailwindcss&logoColor=white)
![PHP](https://img.shields.io/badge/PHP-≥8.2-777BB4?logo=php&logoColor=white)

---

## Содержание

- [Возможности](#возможности)
- [Стек технологий](#стек-технологий)
- [Требования](#требования)
- [Установка](#установка)
- [Переменные окружения](#переменные-окружения)
- [Использование](#использование)
  - [Какие ссылки вставлять](#какие-ссылки-вставлять)
  - [Работа с отзывами](#работа-с-отзывами)
- [Процесс парсинга](#процесс-парсинга)
  - [Общая архитектура](#общая-архитектура)
  - [Шаг 1. Извлечение OID организации](#шаг-1-извлечение-oid-организации)
  - [Шаг 2. Yandex Search API](#шаг-2-yandex-search-api)
  - [Шаг 3. HTML-скрапинг главной страницы](#шаг-3-html-скрапинг-главной-страницы)
  - [Шаг 4. Парсинг страницы отзывов](#шаг-4-парсинг-страницы-отзывов)
  - [Шаг 5. Мерж данных и постобработка](#шаг-5-мерж-данных-и-постобработка)
  - [Кэширование](#кэширование)
  - [Защита от капчи](#защита-от-капчи)
  - [Известные ограничения](#известные-ограничения)
- [Структура проекта](#структура-проекта)
- [Деплой на хостинг](#деплой-на-хостинг)

---

## Возможности

| Функция | Описание |
|---|---|
| **Авторизация** | Регистрация и вход по email/паролю с поддержкой 2FA |
| **Интеграция с Яндекс Картами** | Вставьте ссылку — система автоматически извлечёт данные |
| **Отзывы** | Все отзывы из карточки организации с именем, аватаром и статусом автора |
| **Рейтинг** | Общий рейтинг компании и индивидуальные оценки по каждому отзыву |
| **Фотографии** | До 5 фотографий организации с просмотром в полном размере |
| **Логотип** | Автоматическое определение и отображение аватарки организации |
| **Пагинация** | 50 отзывов на страницу с навигацией |
| **Фильтрация** | По рейтингу (1–5 звёзд) и сортировка по дате |
| **Подгрузка** | Кнопка «Загрузить ещё» для получения дополнительных отзывов |
| **Кэширование** | Результаты кэшируются на 30 минут для быстрой работы |
| **Тёмная тема** | Переключение между светлой и тёмной темой |

---

## Стек технологий

**Backend:** Laravel 12, PHP 8.2+, Fortify (аутентификация)

**Frontend:** Vue 3, Inertia.js, Tailwind CSS 4, Shadcn-vue (UI-компоненты), Lucide (иконки)

**Сборка:** Vite 5

**БД:** SQLite (разработка) / MySQL (продакшен)

---

## Требования

- PHP ≥ 8.2
- Composer ≥ 2.x
- Node.js ≥ 18.x
- npm ≥ 9.x

---

## Установка

```bash
# 1. Клонировать репозиторий
git clone https://github.com/CodeTest-git/testovoe_otsivy.git
cd testovoe_otsivy

# 2. Установить PHP-зависимости
composer install

# 3. Скопировать конфигурацию
cp .env.example .env

# 4. Сгенерировать ключ приложения
php artisan key:generate

# 5. Создать базу данных (SQLite)
touch database/database.sqlite

# 6. Выполнить миграции
php artisan migrate

# 7. Установить JS-зависимости
npm install

# 8. Собрать фронтенд
npm run build

# 9. Запустить сервер разработки
composer dev
```

> После запуска приложение доступно по адресу **http://localhost:8000**

---

## Переменные окружения

В файле `.env` необходимо указать:

| Переменная | Описание | Пример |
|---|---|---|
| `APP_URL` | URL приложения | `http://localhost:8000` |
| `DB_CONNECTION` | Драйвер БД | `sqlite` или `mysql` |
| `DB_DATABASE` | Путь/имя БД | `database/database.sqlite` |

---

## Использование

### Какие ссылки вставлять

После авторизации откройте раздел **«Отзывы»** в боковом меню и вставьте ссылку на организацию из Яндекс Карт.

**Поддерживаемые форматы ссылок:**

1. **Прямая ссылка на организацию** — самый простой формат:

   ```
   https://yandex.ru/maps/org/название/1234567890/
   ```

2. **Ссылка из адресной строки** — когда вы открыли карточку заведения на карте:

   ```
   https://yandex.ru/maps/213/moscow/?ll=37.583207%2C55.766521&mode=poi&poi%5Buri%5D=ymapsbm1%3A%2F%2Forg%3Foid%3D87407731459&z=15
   ```

3. **Ссылка на страницу отзывов** — с `/reviews/` на конце:

   ```
   https://yandex.ru/maps/org/pechorin/87407731459/reviews/
   ```

**Как скопировать ссылку:**

1. Откройте [Яндекс Карты](https://yandex.ru/maps/)
2. Найдите нужное заведение
3. Нажмите на карточку заведения
4. Скопируйте URL из адресной строки браузера
5. Вставьте в поле на странице «Отзывы»

### Работа с отзывами

- **Фильтр по рейтингу** — выберите количество звёзд, чтобы отобразить только отзывы с определённой оценкой
- **Сортировка по дате** — от новых к старым или наоборот
- **Загрузить ещё** — когда доходите до конца загруженных отзывов, нажмите кнопку для подгрузки следующей порции
- **Обновить данные** — нажмите кнопку обновления (↻), чтобы очистить кэш и загрузить свежие данные

---

## Процесс парсинга

Ядро системы — сервис `YandexReviewsService` (`app/Services/YandexReviewsService.php`). Он отвечает за извлечение всех данных об организации из Яндекс Карт. Ниже детально описан каждый этап.

### Общая архитектура

Сбор данных выполняется в 5 этапов и использует **два независимых источника**: Yandex Search API (структурированные данные) и HTML-скрапинг (отзывы, фото, логотип). Результаты обоих источников объединяются — API имеет приоритет по метаданным, HTML — единственный способ получить тексты отзывов.

```
Пользователь вставляет URL
        │
        ▼
┌─────────────────────────┐
│ 1. Извлечение OID       │ ← extractPlaceIdFromUrl()
│    (ID организации)     │   Regex: 4 паттерна для разных форматов URL
└────────┬────────────────┘
         │
    ┌────┴────┐
    ▼         ▼
┌────────┐ ┌──────────────┐
│ 2. API │ │ 3. Скрапинг  │  ← Параллельно: API + 2 HTTP-запроса к HTML
│ Search │ │ HTML-страниц │
└───┬────┘ └──────┬───────┘
    │             │
    └──────┬──────┘
           ▼
┌─────────────────────────┐
│ 5. Мерж + постобработка │ ← Приоритеты, дедупликация, очистка
└─────────────────────────┘
           │
           ▼
      Кэширование (30 мин)
           │
           ▼
      Ответ → Inertia → Vue.js
```

### Шаг 1. Извлечение OID организации

Метод `extractPlaceIdFromUrl()` принимает произвольный URL Яндекс Карт и извлекает из него числовой OID (Object ID) организации. Поддерживаются 4 формата:

| № | Паттерн | Пример |
|---|---------|--------|
| 1 | `poi[uri]=ymapsbm1://org?oid=...` | Параметр `poi[uri]` в URL с карты, внутри которого вложен `oid=` |
| 2 | `&oid=...` | Прямой GET-параметр `oid` |
| 3 | `/org/название/1234567890/` | Числовой сегмент после slug-имени в пути |
| 4 | `/org/1234567890/` | Числовой сегмент сразу после `/org/` |

Все паттерны проверяются последовательно. Если ни один не сработал — возвращается `null`, и пользователю показывается ошибка валидации. Агрессивные fallback'ы (например, «любое число >5 цифр в URL») намеренно не используются, чтобы не перехватить `yclid`, координаты или zoom.

### Шаг 2. Yandex Search API

Метод `fetchOrganizationData()` обращается к **Yandex Organization Search API** (`search-maps.yandex.ru/v1/`) для получения структурированных метаданных:

- **Название компании** — `CompanyMetaData.name`
- **Рейтинг** — `CompanyMetaData.Ratings.score` (float, 1.0–5.0)
- **Количество отзывов** — `CompanyMetaData.Ratings.ratings` (int)

Запрос:
```
GET https://search-maps.yandex.ru/v1/
  ?apikey=<API_KEY>
  &uri=ymapsbm1://org?oid=<OID>
  &type=biz
  &lang=ru_RU
  &results=1
```

> **Примечание:** API-ключ задаётся в `config/services.php` → `yandex_maps.api_key`. Если ключ не настроен, этап пропускается — система полностью работоспособна только на HTML-скрапинге (название и рейтинг будут получены из HTML).

**Таймаут:** 10 секунд. При ошибке — логируем warning и продолжаем без API-данных.

### Шаг 3. HTML-скрапинг главной страницы

Метод `scrapeMainPage()` загружает HTML главной страницы организации:

```
GET https://yandex.ru/maps/org/<OID>/
```

Из неё извлекаются:

#### 3.1 Фотографии (`extractPhotosFromHtml`)

Фото хранятся на CDN `avatars.mds.yandex.net`. Сервис ищет два CDN-префикса:

| Префикс | Описание |
|---------|----------|
| `get-altay` | Основные фотографии организации |
| `get-yandex-maps-*` | Фотографии из отзывов пользователей |

Для каждого найденного URL извлекается **базовый URL** (без суффикса размера), а затем генерируются два варианта:
- `<base>/XXL_height` — полноразмерное изображение (для lightbox)
- `<base>/M` — миниатюра (для сетки)

Извлекается `MAX_PHOTOS + 1` = 6 фото (одно запасное на случай, если первое фото станет логотипом организации).

#### 3.2 Логотип организации (`extractCompanyLogoFromHtml`)

Логотип ищется по 6 стратегиям (в порядке приоритета):

| № | Стратегия | Описание |
|---|-----------|----------|
| 0 | `get-tycoon` CDN-префикс | Специальный CDN-бакет Яндекса для бизнес-логотипов. Любой `get-tycoon` URL — почти гарантированно логотип. |
| 1 | CSS `background-image` + класс `logo` | Элемент с CSS-классом `card-title-view__logo`, `business__logo`, `orgpage__logo` и `background-image` в `style`. |
| 2 | Класс `logo` на родителе | Класс `logo` на родительском элементе, `background-image` на вложенном дочернем `<div>`. |
| 3 | `<img>` с классом `logo` | Тег `<img>` с CSS-классом, содержащим слово `logo`. |
| 4 | JSON `__INITIAL_STATE__` | Поиск по 11 известным JSON-путям: `business.logotype.urlTemplate`, `business.logo.url`, `orgInfo.logotype.urlTemplate` и др. Шаблоны `{size}` заменяются на `islands-68`. |
| 5 | JSON-паттерн `"logoUrl"` | Простой regex-поиск `"logoUrl": "https://..."` в HTML. |

**Валидация логотипа** (`isValidLogoUrl`):
- URL должен начинаться с `https://`
- Отсекаются CDN-префиксы `get-discovery` и `get-discovery-int` — это автогенерированные каталожные миниатюры, а не реальные логотипы

**Fallback:** Если ни одна из 6 стратегий не нашла логотип, в качестве аватарки организации используется первая фотография из галереи (`photos[0]`). Эта фотография при этом удаляется из массива `photos`, чтобы не дублироваться.

> `og:image` намеренно **не используется** — Яндекс подставляет туда произвольное фото из галереи, которое часто не совпадает с основным фото карточки.

#### 3.3 Название из `<title>`

Из тега `<title>` HTML-страницы извлекается название организации — как fallback, если API и Schema.org не предоставили его. Ищется текст в кавычках: `«Название»` или `"Название"`.

### Шаг 4. Парсинг страницы отзывов

Метод `scrapeReviewsPage()` загружает страницу отзывов:

```
GET https://yandex.ru/maps/org/<OID>/reviews/
GET https://yandex.ru/maps/org/<OID>/reviews/?page=2  (для подгрузки)
```

#### 4.1 Извлечение «сырых» отзывов

Используются **3 стратегии** в порядке приоритета:

**Стратегия 1: HTML-блоки (основная)**

Парсер разбивает страницу на блоки по CSS-классу `business-reviews-card-view__review`. Перед парсингом из HTML удаляются теги `<script>`, `<style>`, `<noscript>`, чтобы JS-конфиг не попал в текст отзывов.

Из каждого блока извлекаются:

| Поле | Источник | Паттерн/метод |
|------|----------|---------------|
| **Имя автора** | Schema.org | `itemProp="name"` |
| **Статус** | CSS-класс | `business-review-view__author-caption` |
| **Аватар** | CSS `background-image` или `<img>` | URL с `avatars.mds.yandex.net/get-*` (поддерживаются все CDN-префиксы: `get-altay`, `get-yapic`, `get-lpc`, `get-pdb` и др.) |
| **Профиль** | Ссылка `<a href>` | `https://yandex.ru/maps/user/...` |
| **Рейтинг** | `aria-label` | `aria-label="Оценка X Из 5"`, fallback — подсчёт CSS-классов `_full` |
| **Дата** | Schema.org | `itemProp="datePublished" content="..."` |
| **Текст** | 5 паттернов | См. ниже |

**Извлечение текста отзыва** (5 паттернов по приоритету):

1. `itemProp="reviewBody"` — Schema.org микроразметка (самый надёжный)
2. CSS-класс `business-review-view__body-text`
3. CSS-класс `spoiler-view__text` — для длинных свёрнутых отзывов
4. CSS-класс `business-review-view__body`
5. Fallback — самый длинный фрагмент чистого текста (≥40 символов) внутри блока

**Стратегия 2: `window.__INITIAL_STATE__`**

Если HTML-блоков не найдено, парсер пытается извлечь JSON-объект из `window.__INITIAL_STATE__`. Рекурсивный обход (глубина до 10) ищет ключи `reviews`, `items`, `Comments`, `comments`.

**Стратегия 3: JSON-фрагменты**

Последний вариант — regex-поиск `"reviews": [...]` в HTML и парсинг найденных JSON-массивов.

#### 4.2 Метаданные из HTML страницы отзывов

Метод `extractMetadataFromHtml()` дополнительно извлекает:

| Поле | Приоритет 1 | Приоритет 2 | Приоритет 3 | Приоритет 4 |
|------|-------------|-------------|-------------|-------------|
| **Название** | Schema.org `itemProp="name"` (внутри Organization) | `<title>` (текст в кавычках) | `<title>` (очистка суффиксов) | — |
| **Рейтинг** | Schema.org `itemProp="ratingValue"` | `aria-label="Рейтинг: X.X из 5"` | CSS-класс `rating-badge` | JSON `"totalScore": X.X` |
| **Кол-во отзывов** | Schema.org `itemProp="reviewCount"` | Текст `N отзывов` на странице | — | — |

#### 4.3 Проверка наличия следующей страницы

Парсер ищет ссылку на следующую страницу отзывов (`reviews/?page=N+1`) в HTML. Если найдена — на фронтенде показывается кнопка «Загрузить ещё».

### Шаг 5. Мерж данных и постобработка

#### 5.1 Приоритеты источников

```
Название:   API > Schema.org > <title> > slug из URL > "Компания из Яндекс.Карт"
Рейтинг:    API > Schema.org > aria-label > CSS > JSON > 0.0
Кол-во:     API > Schema.org > текст на странице > кол-во спарсенных отзывов
Логотип:    HTML-парсинг (6 стратегий) > photos[0] > null
```

#### 5.2 Очистка отзывов (`cleanAndMergeReviews`)

Яндекс.Карты при HTML-парсинге могут выдавать разрозненные записи:

1. Запись с именем автора, но без текста
2. Мусорная запись «Подписаться», «Показать ещё» и т.д.
3. Запись с текстом, но автор — «Аноним»

Алгоритм объединения:
- Если встречается запись **с именем, но без текста** — имя запоминается (`pendingAuthor`)
- Мусорные тексты (из списка `GARBAGE_TEXTS`) и короткие строки (<15 символов без пунктуации) отбрасываются
- Тексты, похожие на JSON/JS-код, отбрасываются (проверка по `looksLikeCode()` — >15% спецсимволов, шаблоны `{{variable}}`, начало с `{` или `[`)
- Если следующая запись **с текстом, но без имени** — подставляется `pendingAuthor`
- HTML-сущности (`&quot;`, `&amp;`, `&#039;` и др.) декодируются через `html_entity_decode()`

Мусорные тексты, которые фильтруются:
```
подписаться, оцените это место, показать ещё, показать еще, ещё,
скопировать, ответить, пожаловаться, полезно, не полезно,
комментировать, читать далее, свернуть, загрузить ещё
```

Также отфильтровываются UI-паттерны вида «Еда • 88%», «Обслуживание • 92%» и строки, состоящие только из цифр/спецсимволов.

#### 5.3 Дедупликация логотипа в галерее

Если логотип совпадает с одной из фотографий в галерее (сравнение по базовому URL без суффикса размера), эта фотография удаляется из массива `photos`. Итого в галерее всегда ≤ 5 фотографий.

### Кэширование

| Что кэшируется | Ключ кэша | TTL |
|----------------|-----------|-----|
| Основные данные (компания + первая страница отзывов) | `yandex_reviews:<OID>:main` | 30 минут |
| Дополнительные страницы отзывов (page=2, 3, ...) | `yandex_reviews:<OID>:page:<N>` | 15 минут |

- Кнопка **«Обновить»** на фронтенде сбрасывает весь кэш для текущей организации (основной + до 20 страниц отзывов) и перезагружает страницу.
- При **смене URL** кэш старой организации автоматически очищается.

### Защита от капчи

Яндекс может вернуть страницу с капчей вместо контента. Метод `isCaptchaPage()` детектирует это по маркерам:

- `CheckboxCaptcha` или `captcha-page` — однозначная капча
- `SmartCaptcha` — только если на странице нет блоков с отзывами (`business-reviews-card-view`)
- Текст «Подтвердите, что вы не робот» — только если нет контента организации

> **Важно:** Слово `captcha` присутствует на **всех** страницах Яндекса (в ссылке на fingerprint-библиотеку `captchapgrd`), поэтому простой `str_contains($html, 'captcha')` даёт ложноположительные срабатывания. Используются более специфичные маркеры.

### Известные ограничения

1. **Яндекс может изменить HTML-разметку** — парсинг основан на CSS-классах (`business-reviews-card-view__review`, `business-review-view__body-text` и др.), которые Яндекс может переименовать в любой момент. В этом случае стратегия 1 перестанет работать, и система переключится на стратегии 2 и 3 (JSON-парсинг), либо покажет демо-данные.

2. **Rate limiting** — при частых запросах Яндекс может вернуть капчу. HTTP-заголовки имитируют обычный браузер (`User-Agent`, `Accept-Language`), но при агрессивном использовании блокировка возможна. Кэширование снижает количество запросов.

3. **Количество отзывов за раз** — Яндекс отдаёт ~10–20 отзывов на страницу. Для получения всех отзывов используется постраничная подгрузка через кнопку «Загрузить ещё».

4. **Аватары пользователей** — извлекаются из CSS `background-image` и тегов `<img>`. Поддерживаются все известные CDN-префиксы Яндекса (`get-altay`, `get-yapic`, `get-lpc`, `get-pdb`, `get-entity-icon`, `get-yandex-maps-users` и др.), но при появлении нового префикса аватар может не распознаться.

---

## Структура проекта

```
testovoe_otsivy/
├── app/
│   ├── Http/Controllers/
│   │   └── YandexIntegrationController.php   # Контроллер интеграции
│   └── Services/
│       └── YandexReviewsService.php          # Сервис парсинга Яндекс Карт
├── config/
│   └── services.php                          # Конфигурация API-ключей
├── database/
│   └── migrations/                           # Миграции БД
├── resources/js/
│   ├── pages/
│   │   ├── Welcome.vue                       # Главная страница (лендинг)
│   │   └── yandex/
│   │       └── Integration.vue               # Страница отзывов
│   ├── components/
│   │   └── AppSidebar.vue                    # Боковая панель навигации
│   └── composables/
│       └── useAppearance.ts                  # Переключение темы
├── routes/
│   └── web.php                               # Маршруты приложения
└── public/
    └── build/                                # Скомпилированный фронтенд
```

---

## Деплой на хостинг

### Подготовка

```bash
# Убедитесь, что фронтенд собран
npm run build
```

### На сервере

```bash
# Установить зависимости (без dev-пакетов)
composer install --no-dev --optimize-autoloader

# Настроить .env (DB_CONNECTION=mysql, APP_DEBUG=false, ...)
nano .env

# Сгенерировать ключ
php artisan key:generate

# Запустить миграции
php artisan migrate --force

# Кэширование для production
php artisan config:cache
php artisan route:cache
php artisan view:cache

# Права на запись
chmod -R 775 storage bootstrap/cache
```

> **Document Root** веб-сервера должен указывать на папку `public/`.

---

## Лицензия

MIT
